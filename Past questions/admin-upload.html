<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Past Question - Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@300;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/courses.css">
    <style>
        .upload-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .upload-container h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #555;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-upload {
            border: 2px dashed #667eea;
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: #f8f9ff;
        }

        .file-upload.drag-over {
            background: #e8ebff;
            border-color: #5568d3;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background: #5568d3;
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
            display: none;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="breadcrumb">
            <a href="past-questions.html">‚Üê Back to Home</a>
        </nav>

        <h1>üì§ Upload Past Question</h1>

        <div class="upload-container">
            <div id="message" class="message"></div>

            <form id="uploadForm">
                <h2>Question Details</h2>

                <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" required placeholder="e.g., Economics Final Exam 2023">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="faculty">Faculty *</label>
                        <select id="faculty" required>
                            <option value="">Select Faculty</option>
                            <option value="Faculty of Social Science Education">Faculty of Social Science Education</option>
                            <option value="General Papers">General Papers</option>
                            <option value="Faculty of Science Education">Faculty of Science Education</option>
                            <option value="School of Business">School of Business</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="department">Department *</label>
                        <input type="text" id="department" required placeholder="e.g., Economics">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="level">Level *</label>
                        <select id="level" required>
                            <option value="">Select Level</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="300">300</option>
                            <option value="400">400</option>
                            <option value="500">500</option>
                            <option value="600">600</option>
                            <option value="700">700</option>
                            <option value="800">800</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="semester">Semester *</label>
                        <select id="semester" required>
                            <option value="">Select Semester</option>
                            <option value="first">First Semester</option>
                            <option value="second">Second Semester</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="courseCode">Course Code</label>
                        <input type="text" id="courseCode" placeholder="e.g., ECON 101">
                    </div>

                    <div class="form-group">
                        <label for="courseName">Course Name</label>
                        <input type="text" id="courseName" placeholder="e.g., Introduction to Economics">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="year">Year</label>
                        <input type="number" id="year" placeholder="2024" min="2000" max="2030">
                    </div>

                    <div class="form-group">
                        <label for="price">Price (GH‚Çµ)</label>
                        <input type="number" id="price" step="0.01" min="0" value="0">
                    </div>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="isFree">
                    <label for="isFree">Mark as Free</label>
                </div>

                <h2 style="margin-top: 30px;">Upload PDF</h2>

                <div class="file-upload" id="fileUpload">
                    <p>üìÑ Drag and drop PDF file here or click to browse</p>
                    <input type="file" id="fileInput" accept="application/pdf" style="display: none;" required>
                </div>

                <div class="file-info" id="fileInfo"></div>

                <button type="submit" class="upload-btn" id="submitBtn">Upload Past Question</button>
            </form>
        </div>
    </div>

    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="scripts/supabase-config.js"></script>
    <script src="scripts/supabase-auth.js"></script>
    <script src="scripts/supabase-db.js"></script>

    <script>
        let selectedFile = null;

        // File upload handling
        const fileUpload = document.getElementById('fileUpload');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');

        fileUpload.addEventListener('click', () => fileInput.click());

        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('drag-over');
        });

        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('drag-over');
        });

        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (file.type !== 'application/pdf') {
                showMessage('Please select a PDF file', 'error');
                return;
            }

            selectedFile = file;
            const sizeMB = (file.size / 1024 / 1024).toFixed(2);
            fileInfo.innerHTML = `
                <strong>üìÑ ${file.name}</strong><br>
                Size: ${sizeMB} MB
            `;
            fileInfo.style.display = 'block';
        }

        // Free checkbox handling
        document.getElementById('isFree').addEventListener('change', (e) => {
            const priceInput = document.getElementById('price');
            if (e.target.checked) {
                priceInput.value = 0;
                priceInput.disabled = true;
            } else {
                priceInput.disabled = false;
            }
        });

        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedFile) {
                showMessage('Please select a PDF file', 'error');
                return;
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Uploading...';

            const metadata = {
                title: document.getElementById('title').value,
                faculty: document.getElementById('faculty').value,
                department: document.getElementById('department').value,
                level: parseInt(document.getElementById('level').value),
                semester: document.getElementById('semester').value,
                courseCode: document.getElementById('courseCode').value || null,
                courseName: document.getElementById('courseName').value || null,
                year: parseInt(document.getElementById('year').value) || null,
                price: parseFloat(document.getElementById('price').value) || 0,
                isFree: document.getElementById('isFree').checked
            };

            const result = await window.dbOperations.uploadPastQuestion(selectedFile, metadata);

            if (result.success) {
                showMessage('Past question uploaded successfully!', 'success');
                document.getElementById('uploadForm').reset();
                selectedFile = null;
                fileInfo.style.display = 'none';
            } else {
                showMessage('Upload failed: ' + result.error, 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Upload Past Question';
        });

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Check authentication on load
        window.addEventListener('load', async () => {
            const result = await window.authFunctions.getCurrentUser();
            if (!result.success || !result.user) {
                alert('Please log in to upload past questions');
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
